# 全局行为规则

> **版本**: v1.0
> **适用范围**: 所有节点
> **优先级**: HIGH
> **最后更新**: 2024-01-23

---

## 规则列表

### G-01: 上下文窗口管理

**要求**: MUST
**描述**: 严格遵守上下文窗口大小限制，避免 token 累积导致性能下降

**配置**:
- `CONTEXT_WINDOW_SIZE = 5` - 保留最近 5 步操作记录
- `MEMORY_WINDOW_SIZE = 6` - 保留最近 6 条消息在内存

**执行要点**:
- 超出窗口的历史记录应转入向量记忆
- 每步操作完成后检查窗口大小
- 优先保留关键信息（错误、决策、结论）

---

### G-02: 错误处理与记录

**要求**: MUST
**描述**: 遇到错误时，必须详细记录到 findings.md，避免重复相同错误

**错误处理流程**:
1. 捕获完整的错误信息（类型、消息、堆栈）
2. 分析根本原因（不只是表面现象）
3. 记录到 `findings.md`（标记为 `critical` 级别）
4. 提供用户友好的错误提示（中文）
5. 如果可能，提供解决方案或下一步建议

**记录格式**:
```markdown
## [ERROR] 错误简述

- **时间**: 2024-01-23 20:30
- **位置**: ToolNode / generate_image
- **原因**: MEMORY_SIMILARITY_THRESHOLD 未定义
- **影响**: 程序崩溃
- **解决**: 添加常量定义 MEMORY_SIMILARITY_THRESHOLD = 0.65
- **预防**: 代码审查时检查所有使用的常量是否已定义
```

---

### G-03: 输出格式规范

**要求**: SHOULD
**描述**: 所有输出应使用 Markdown 格式，结构清晰，便于阅读

**格式要求**:
- 使用标题分层（`##`, `###`）
- 列表使用 `-` 或 `1.`
- 代码使用代码块（\`\`\`）
- 重要信息使用加粗（`**文本**`）
- 区分成功 ✅ 和错误 ❌

**示例**:
```markdown
## 任务执行结果

✅ **成功生成图片**

- **提示词**: 一只可爱的猫
- **图片URL**: http://example.com/image.png
- **耗时**: 8.5 秒

### 下一步建议
1. 检查图片质量
2. 如满意，保存到本地
```

---

### G-04: 中文优先原则

**要求**: SHOULD
**描述**: 所有用户可见的输出应使用中文（除非用户明确要求英文）

**例外情况**:
- 工具参数名称（如 `response_format`）
- 代码变量名
- 日志关键字（如 `[ERROR]`, `[INFO]`）
- 技术术语保留英文（如 MCP, API, JSON）

**示例**:
```markdown
✅ 正确: "正在生成图片，请稍候..."
❌ 错误: "Generating image, please wait..."

✅ 正确: "调用工具 generate_image，参数 response_format='url'"
❌ 错误: "Call tool generate_image, parameter response_format='url'"
```

---

### G-05: 工具调用基本原则

**要求**: MUST
**描述**: 调用任何工具前，必须验证参数完整性和正确性

**检查清单**:
- ✅ 必填参数是否全部提供？
- ✅ 参数类型是否正确？（string, number, boolean, array）
- ✅ 枚举值是否在允许范围内？
- ✅ 参数格式是否符合要求？（URL, file path, JSON）

**特殊注意 - 图片生成工具**:
- **MUST**: 使用 `response_format="url"` 而非 `"b64_json"`
- **原因**: Base64 编码图片过大（>100,000 字符）会被截断
- **例外**: 仅当明确需要离线使用时才用 Base64

**正确示例**:
```python
# ✅ 推荐
submit_generate_image(
    prompt="一只可爱的橘猫",
    response_format="url",  # 使用 URL 格式
    size="1024x1024"
)

# ❌ 避免
submit_generate_image(
    prompt="一只可爱的橘猫",
    response_format="b64_json"  # 会导致截断！
)
```

---

### G-06: 任务规划遵守

**要求**: MUST
**描述**: 每次决策前必须重读 `task_plan.md`，确保行动符合总体计划

**Manus-style 注意力操纵**:
- 决策节点（DecideNode）执行前读取 `task_plan.md`
- 检查当前步骤是否在计划范围内
- 确认计划完成度
- 发现偏离时及时调整

**计划文件**:
- `task_plan.md` - 任务总体规划
- `findings.md` - 关键发现和错误记录
- `progress.md` - 执行进度跟踪

---

### G-07: 记忆检索利用

**要求**: SHOULD
**描述**: 决策前应检查历史记忆，参考过去的经验和教训

**检索时机**:
- 开始新任务时
- 遇到类似问题时
- 需要领域知识时

**利用方式**:
- 如果找到相关记忆（相似度 >= 0.65），优先参考
- 如果发现错误记录，避免重复相同错误
- 借鉴成功经验，复用最佳实践

**相似度阈值**:
- `>= 0.85` - 高度相似，可能是重复
- `>= 0.65` - 中等相关，值得参考
- `< 0.65` - 不相关，过滤掉

---

### G-08: 不确定性处理

**要求**: MUST
**描述**: 当存在不确定性或多种选项时，必须明确说明并征求用户意见

**处理步骤**:
1. 列出所有可能的选项
2. 说明每个选项的优缺点
3. 提供推荐方案（标注 "推荐"）
4. 询问用户偏好

**示例**:
```markdown
## 方案选择

当前存在两种实现方案：

### 方案 A：使用异步工具（推荐）✅
**优点**:
- 避免超时（>30秒）
- 可以并行处理多个任务
- 实时查询进度

**缺点**:
- 需要两步调用（submit + get_result）
- 代码稍复杂

### 方案 B：使用同步工具
**优点**:
- 一步调用，代码简单

**缺点**:
- 可能超时导致失败
- 阻塞后续操作

**推荐**: 方案 A（异步工具）

请问您希望使用哪个方案？
```

---

### G-09: 响应时效性

**要求**: SHOULD
**描述**: 操作完成后应及时反馈给用户，保持良好的交互体验

**反馈时机**:
- 开始执行任务时 - "正在生成图片..."
- 长时间操作中 - "预计需要 10 秒，请稍候..."
- 操作完成时 - "✅ 图片生成成功"
- 出现错误时 - "❌ 生成失败，原因：XXX"

**进度更新**:
- 超过 5 秒的操作应提供进度反馈
- 超过 30 秒的操作应使用异步模式

---

### G-10: 安全与隐私

**要求**: MUST
**描述**: 保护用户隐私和敏感信息

**禁止行为**:
- ❌ 在日志中记录完整的 API Key
- ❌ 在输出中暴露敏感路径（如用户主目录）
- ❌ 存储未加密的密码或密钥

**脱敏处理**:
```python
# ✅ 正确
api_key = "sk-ant-abc123...xyz"  # 日志中显示
print(f"Using API key: {api_key[:10]}***")

# ❌ 错误
print(f"API key: {api_key}")  # 完整暴露
```

---

## 规则说明

### 要求级别定义

| 级别 | 含义 | 违反后果 |
|------|------|----------|
| **MUST** | 必须遵守 | 可能导致错误、数据损坏或安全问题 |
| **SHOULD** | 应该遵守 | 影响用户体验或代码质量 |
| **MAY** | 可以遵守 | 可选建议，视情况而定 |

### 规则更新日志

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v1.0 | 2024-01-23 | 初始版本，10条全局规则 |
| v1.1 | 2026-01-24 | 新增 G-11 Moji天气工具使用规范 |

---

### G-11: Moji天气工具使用规范

**要求**: MUST
**描述**: 调用任何 Moji 天气相关工具（如 `天气实况`、`天气预报24小时`、`天气预报15天` 等）前，必须先获取正确的 `cityId`

**获取 cityId 的标准流程**:

1. **定位数据源文件**：
   - 路径：`E:\AI\my-pocketflow\sandbox\moji城市信息列表.xlsx`
   - 该文件包含所有支持城市的 ID 映射

2. **读取并查找城市ID**：
   - 使用 `excel_stdio` 工具读取该 Excel 文件
   - 在 **B列（城市名称）** 中查找目标城市
   - 获取匹配行 **A列** 对应的数值，即为 `cityId`

3. **调用 Moji 天气工具**：
   - 使用步骤2获取的 `cityId` 作为参数
   - Token 参数会在工具定义中自动提供默认值，无需手动指定

**示例流程**:
```
用户: 查询北京市石景山区的24小时天气预报

操作步骤:
1. 调用 excel_stdio 读取 moji城市信息列表.xlsx
2. 在 B 列查找"北京市石景山区"
3. 获取对应 A 列的 cityId（如: 12）
4. 调用 天气预报24小时 工具，传入 cityId（token 使用默认值）
```

**注意事项**:
- ❌ **禁止跳过 cityId 获取步骤**，直接使用城市名称调用工具
- ❌ **禁止猜测 cityId**，必须从数据源文件读取
- ✅ **每次查询前都应确认 cityId**，除非已在本次对话中获取过
- ✅ **Token 使用工具定义中的默认值**，无需在调用时指定

---

**规则文件结束**
